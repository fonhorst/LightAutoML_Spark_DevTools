#!/bin/bash

set -ex

DOCKER_REPO=node2.bdcl:5000

function build_images() {
  replay_project_path="../../RePlay"
  replay_build_path="./docker/replay_build_tmp"

  rm -rf "$replay_build_path"
  mkdir -p "$replay_build_path"

  cp ${replay_project_path}/dist/replay_rec-0.10.0-py3-none-any.whl ${replay_build_path}
  cp ${replay_project_path}/jars/replay_2.12-0.1.jar ${replay_build_path}
  cp -r examples-spark ${replay_build_path}/examples-spark/

  docker build -t "${DOCKER_REPO}/replay:latest" -f ./docker/replay.dockerfile ./docker

  rm -rf ${replay_build_path}
}

function push_images() {
    docker push "${DOCKER_REPO}/replay:latest"
}

function install_images() {
    build_images
    push_images
}

function restart_scenario() {
  kubectl -n spark-lama-exps delete -f replay-yarn-job.yml --ignore-not-found
  kubectl -n spark-lama-exps apply -f replay-yarn-job.yml
}

function stop_scenario() {
    kubectl -n spark-lama-exps delete -f replay-yarn-job.yml --ignore-not-found
}

function help() {
  echo "
  List of commands.
    help - prints this message
  "
}

function main () {
    cmd="$1"

    if [ -z "${cmd}" ]
    then
      echo "No command is provided."
      help
      exit 1
    fi

    shift 1

    echo "Executing command: ${cmd}"

    case "${cmd}" in
      "build-images")
          build_images
          ;;

      "push-images")
          push_images
          ;;

      "install-images")
          install_images
          ;;

      "restart-scenario")
          restart_scenario
          ;;

      "stop-scenario")
          stop_scenario
          ;;

      "help")
          help
          ;;

      *)
          echo "Unknown command: ${cmd}"
          ;;

    esac
}

main "${@}"
